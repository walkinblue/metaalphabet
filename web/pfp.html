<html>
    <head>
        <style>
            input{
                width: 240px;
            }
            div{
                display: flex;
                flex-direction: row;
                justify-content: flex-start;
                margin-bottom: 20px;
                align-items: flex-start;
            }
            .sentance{
                width: 400px;
            }
            textarea{
                width: 400px;
                height: 60px;
            }
            .button{
                width: 200px;
                font-weight: bold;
            }
            text{
                font-weight: bold;
                width: 140px;

            }
            .title{
                width: 400px;
                font-size: 20px;
                text-align: center;
                width: 420px;

            }
            .buttons{
                width: 420px;
                
            }
            img{
                width: 40px;
                height: 40px;
                margin: 8px;
            }
            .parameter{
                width: 50px;
                margin-right: 10px;
            }
            .paratitle{
                width: 70px;
                font-weight: normal;
                text-align: right;
                margin-right: 5px;
            }
            .imagesdiv{
                display: flex;
                flex-direction: column;
            }
            .imageresult{
                width: 40px;
                height: 40px;
                margin: 8px;
            }
            .imagediv{
                display: flex;
                flex-direction: column;
            }
            .trait{
                width: 60px;
                text-align: center;
            }
            .metadata{
                display: flex;
                flex-direction: column;
            }
            .metadata_title{
                font-weight: normal;
            }
            .subline{
                height: 20px;
            }
            .tip{
                font-weight: normal;
                font-size: 12px;
                line-height: 20px;
                margin-left: 10px;
            }
        </style>
        <script type="module">
            import dataJson from '/uploads/data.json' assert {type: 'json'};
            import traitsJson from '/uploads/traits.json' assert {type: 'json'};

            const groupIds = ["01", "02", "03", "04", "05", "06", "07", "08", "09"];
            function loadData(){
                console.log(dataJson);
                if(dataJson){
                    if(dataJson.size){document.getElementsByName("size")[0].value = dataJson.size;}
                    if(dataJson.amount){document.getElementsByName("amount")[0].value = dataJson.amount;}
                    if(dataJson.contract_uri){document.getElementsByName("contract_uri")[0].value = dataJson.contract_uri;}
                    if(dataJson.name){document.getElementsByName("collection_name")[0].value = dataJson.name;}
                    if(dataJson.description){document.getElementsByName("collection_description")[0].value = dataJson.description;}
                    if(dataJson.image){document.getElementsByName("collection_image")[0].value = dataJson.image;}
                    if(dataJson.external_link){document.getElementsByName("external_link")[0].value = dataJson.external_link;}
                    if(dataJson.seller_fee_basis_points){document.getElementsByName("seller_fee_basis_points")[0].value = dataJson.seller_fee_basis_points;}
                    if(dataJson.item){
                        if(dataJson.item.image){document.getElementsByName("token_image")[0].value = dataJson.item.image;}
                        if(dataJson.item.external_url){document.getElementsByName("token_external_url")[0].value = dataJson.item.external_url;}
                        if(dataJson.item.description){document.getElementsByName("token_description")[0].value = dataJson.item.description;}
                        if(dataJson.item.name){document.getElementsByName("token_name")[0].value = dataJson.item.name;}
                        if(dataJson.item.background_color){document.getElementsByName("token_background_color")[0].value = dataJson.item.background_color;}
                        if(dataJson.item.animation_url){document.getElementsByName("token_animation_url")[0].value = dataJson.item.animation_url;}
                        if(dataJson.item.youtube_url){document.getElementsByName("token_youtube_url")[0].value = dataJson.item.youtube_url;}
                    }
                    let data = dataJson.data;
                    if(data){
                        console.log(data);
                        for(let i = 0 ;  i < data.length ; i ++ ){
                            let d = data[i];
                            let id = groupIds[i];
                            document.getElementsByName("group"+id)[0].value = d.group;
                            document.getElementsByName("zoom"+id)[0].value = d.zoom;
                            document.getElementsByName("movex"+id)[0].value = d.movex;
                            document.getElementsByName("movey"+id)[0].value = d.movey;
                            document.getElementsByName("rotate"+id)[0].value = d.rotate;
                            if(d.trait)document.getElementsByName("trait"+id)[0].value = d.trait;
                            loadImages(id, d);
                        }
                    }
                }
                document.getElementsByName("images01")[0].addEventListener("change", () => { loadFaceImage("01", document.getElementsByName("images01")[0])});
                document.getElementsByName("images02")[0].addEventListener("change", () => { loadFaceImage("02", document.getElementsByName("images02")[0])});
                document.getElementsByName("images03")[0].addEventListener("change", () => { loadFaceImage("03", document.getElementsByName("images03")[0])});
                document.getElementsByName("images04")[0].addEventListener("change", () => { loadFaceImage("04", document.getElementsByName("images04")[0])});
                document.getElementsByName("images05")[0].addEventListener("change", () => { loadFaceImage("05", document.getElementsByName("images05")[0])});

                document.getElementById("submit").addEventListener("click", commit);
                document.getElementById("showresult").addEventListener("click", showresult);

                let client = new XMLHttpRequest();
                    client.open('GET', "outputs/running?time="+Date.now());
                    client.onreadystatechange = function() {
                        if (this.readyState == 4) {
                            if (this.status == 404) {
                                console.log("404 detected");
                            }else{
                                commit();
                            }
                        }
                    }
                    client.send();

            }
            function loadImages(id, input){
                if(!input.files)return;
                let div = "faceDiv"+id;
                let i = 0;
                let face = document.getElementById(div);
                face.innerHTML = '';
                
                for(let i = 0 ; i < input.files.length ; i ++ ){
                    let face = document.getElementById(div);
                    let img = document.createElement("img");
                    img.src = "../"+input.files[i].path;
                    // console.log(img.src);

                    let imgdiv = document.createElement("div");
                    let trait = document.createElement("input");
                    face.appendChild(imgdiv);
                    imgdiv.appendChild(img);
                    imgdiv.appendChild(trait);
                    imgdiv.className="imagediv";
                    trait.type = "text";
                    trait.className="trait";
                    trait.name = "trait"+id+"_"+i;;
                    if(input.files[i].trait)
                        trait.value = input.files[i].trait;

                }
            }
            function loadFaceImage(id, input){
                if(!input.files)return;
                let i = 0;
                let div = "faceDiv"+id;
                let face = document.getElementById(div);
                face.innerHTML = '';
                for(let i = 0 ; i < input.files.length ; i ++ ){
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        let face = document.getElementById(div);
                        let imgdiv = document.createElement("div");
                        let img = document.createElement("img");
                        let trait = document.createElement("input");
                        face.appendChild(imgdiv);
                        imgdiv.appendChild(img);
                        imgdiv.appendChild(trait);
                        imgdiv.className="imagediv";
                        img.src = e.target.result;
                        img.title = input.files[i].name;
                        trait.type = "text";
                        trait.className="trait";
                        trait.name = "trait"+id+"_"+i;
                        if(traitsJson){
                            if(traitsJson[input.files[i].name])
                                trait.value = traitsJson[input.files[i].name];
                        }
                        //console.log()
                        // img.class = 
                    };
                    reader.readAsDataURL(input.files[i]);
                }
            }

            var check = null;
            function showresult(){
                // alert(amount);
                let amount = document.getElementById("amount").value;
                let result = document.getElementById("result");
                result.style.display = "block";
                result.innerHTML = '';

                let latency = 0;
                for(let i=1 ; i <= amount ; i++ ){    
                    latency = (i - (i%100))/100 * 1000
                    setTimeout(function(){
                        let img = document.createElement("img");
                        img.src = "outputs/"+i+".png?time="+Date.now();
                        img.className = "imageresult";
                        result.appendChild(img);

                        
                        let client = new XMLHttpRequest();
                        client.open('GET', "outputs/"+i+".json");
                        client.onreadystatechange = function() {
                            img.title = i+".png:"+client.responseText;
                        }
                        client.send();
                    }, latency);
                }
            }
            

            function commit(){
                let result = document.getElementById("result");
                result.style.display = "none";

                console.log("submit");
                setTimeout(function(){
                    document.getElementById("submit").disabled = true;
                    document.getElementById("loading").style.display="block";
                    document.getElementById("showing").style.display="none";
                }, 2)

                check = setInterval(function(){
                    let client = new XMLHttpRequest();
                    client.open('GET', "outputs/done?time="+Date.now());
                    client.onreadystatechange = function() {
                        if (this.readyState == 4) {
                            if (this.status == 404) {
                                console.log("404 detected");
                            }else{
                                console.log("ready");
                                if(check)clearInterval(check);
                                document.getElementById("submit").disabled = false;
                                document.getElementById("loading").style.display="none";
                                document.getElementById("showing").style.display="block";
                                showresult();
                            }
                        }
                    }
                    client.send();

                },2000);

            }

            window.addEventListener('load', loadData);
            document.getElementById("form").action = `http://${window.location.host}:8001/upload`;
        </script>
        <script  type="text/javascript">
            
        </script>
    </head>
    <body>
        <div><text class="title">NFT PFP Generator</text></div>
        <form id="form" method="post" enctype="multipart/form-data" action="http://localhost:8001/upload">
            <div>
                <text>Amount:</text>
                <input id="amount" name="amount" type="number" value="100">
            </div>
            <div>
                <text>Sizexsize:</text>
                <input id="size" name="size" type="number" value="1024" >
            </div>
            <div>
                <text>Collection:</text>
                <div class="metadata">
                    <div class="subline">
                        <text class="metadata_title">contract URI:</text>
                        <div  style="background-color:#00ff00">
                            <input id="contract_uri" name="contract_uri" type="text" value="" ></input>
                        </div>
                    </div>
                    <div class="subline">
                        <text class="metadata_title">collection name:</text>
                        <div>
                            <input id="collection_name" name="collection_name" type="text" value="" ></input>
                        </div>
                    </div>                        
                    <div class="subline" style="height: 60px;">
                        <text class="metadata_title">collection desc.:</text>
                        <div class="metadata">
                            <textarea id="collection_description" name="collection_description" type="text" ></textarea>
                        </div>
                    </div>
                    <div class="subline">
                        <text class="metadata_title">collection image:</text>
                        <div class="metadata">
                            <input id="collection_image" name="collection_image" type="text" value="" ></input>
                        </div>
                    </div>
                    <div class="subline">
                        <text class="metadata_title">external link:</text>
                        <div >
                            <input id="external_link" name="external_link" type="text" value="" ></input>
                        </div>
                    </div>
                    <div class="subline">
                        <text class="metadata_title">seller fee:</text>
                        <div>
                            <input id="seller_fee_basis_points" name="seller_fee_basis_points" type="text" value="100" ></input><text class="tip"> 100 = 1%.</text>
                        </div>
                    </div>
                    <div class="subline">
                        <text class="metadata_title">fee recepeint:</text>
                        <div>
                            <text style="font-weight: normal; width:400px; font-size:16px; ">can't change, please contact dev for now.</text>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <text>Item MetaData:</text>
                <div class="metadata">
                    <div>
                        <text class="metadata_title">description:</text>
                        <textarea id="token_description" name="token_description" type="text" >This is no {no} pic. </textarea>
                    </div>    
                    <div>
                        <text class="metadata_title">external url:</text>
                        <input id="token_external_url" name="token_external_url" type="text" value="https://ext_url/{no}.png " ></input>
                    </div>    
                    <div>
                        <text class="metadata_title">image:</text>
                        <input id="token_image" name="token_image" type="text" value="https://url/{no}.png" ></input>
                    </div>    
                    <div>
                        <text class="metadata_title">name:</text>
                        <input id="token_name" name="token_name" type="text" value="No {no} PFP" ></input>
                    </div>    
                    <div>
                        <text class="metadata_title">bg olor (op):</text>
                        <input id="token_background_color" name="token_background_color" type="text" value="" ></input> <text class="tip">FFFFFF</text>
                    </div>    
                    <div>
                        <text class="metadata_title">animation url (op):</text>
                        <input id="token_animation_url" name="token_animation_url" type="text" value="" ></input> <text class="tip">https://url/{no}.mp4</text>
                    </div>    
                    <div>
                        <text class="metadata_title">youtube url (op):</text>
                        <input id="token_youtube_url" name="token_youtube_url" type="text" value="" ></input> <text class="tip">https://www.youtube.com/XXXX</text>
                    </div>    
                </div>
            </div>
            <div class="imagesdiv">
                <div>
                    <text>Images01 Files:</text>
                    <input name="images01" type="file" multiple accept="image/png, image/jpeg">
                </div>
                <div>
                    <text>Parameters:</text>
                    <text class="paratitle">groupid</text><input name="group01" type="number" value="1" class="parameter">
                    <text class="paratitle">zoom</text><input name="zoom01" step="0.01" type="number" value="1.0" class="parameter">
                    <text class="paratitle">move-x</text><input name="movex01" type="number" value="0" class="parameter">
                    <text class="paratitle">move-y</text><input name="movey01" type="number" value="0" class="parameter">
                    <text class="paratitle">rotate</text><input name="rotate01" type="number" value="0" class="parameter">
                    <text class="paratitle">trait name</text><input name="trait01" type="text" class="parameter">
                </div>
                <div id="faceDiv01"></div>
            </div>
            <div class="imagesdiv">
                <div>
                    <text>Images02 Files:</text>
                    <input name="images02" type="file" multiple onchange="loadFaceImage('02', this);" accept="image/png, image/jpeg">
                </div>
                <div>
                    <text>Parameters:</text>
                    <text class="paratitle">groupid</text><input name="group02" type="number" value="2" class="parameter">
                    <text class="paratitle">zoom</text><input name="zoom02" step="0.01" type="number" value="1.0" class="parameter">
                    <text class="paratitle">move-x</text><input name="movex02" type="number" value="0" class="parameter">
                    <text class="paratitle">move-y</text><input name="movey02" type="number" value="0" class="parameter">
                    <text class="paratitle">rotate</text><input name="rotate02" type="number" value="0" class="parameter">
                    <text class="paratitle">trait name</text><input name="trait02" type="text" class="parameter">
                </div>
                <div id="faceDiv02"></div>
            </div>

            <div class="imagesdiv">
                <div>
                    <text>Images03 Files:</text>
                    <input name="images03" type="file" multiple onchange="loadFaceImage('03', this);" accept="image/png, image/jpeg">
                </div>
                <div>
                    <text>Parameters:</text>
                    <text class="paratitle">groupid</text><input name="group03" type="number" value="3" class="parameter">
                    <text class="paratitle">zoom</text><input name="zoom03" step="0.01" type="number" value="1.0" class="parameter">
                    <text class="paratitle">move-x</text><input name="movex03" type="number" value="0" class="parameter">
                    <text class="paratitle">move-y</text><input name="movey03" type="number" value="0" class="parameter">
                    <text class="paratitle">rotate</text><input name="rotate03" type="number" value="0" class="parameter">
                    <text class="paratitle">trait name</text><input name="trait03" type="text" class="parameter">
                </div>
                <div id="faceDiv03"></div>
            </div>

            <div class="imagesdiv">
                <div>
                    <text>Images04 Files:</text>
                    <input name="images04" type="file" multiple onchange="loadFaceImage('04', this);" accept="image/png, image/jpeg">
                </div>
                <div>
                    <text>Parameters:</text>
                    <text class="paratitle">groupid</text><input name="group04" type="number" value="4" class="parameter">
                    <text class="paratitle">zoom</text><input name="zoom04" step="0.01" type="number" value="1.0" class="parameter">
                    <text class="paratitle">move-x</text><input name="movex04" type="number" value="0" class="parameter">
                    <text class="paratitle">move-y</text><input name="movey04" type="number" value="0" class="parameter">
                    <text class="paratitle">rotate</text><input name="rotate04" type="number" value="0" class="parameter">
                    <text class="paratitle">trait name</text><input name="trait04" type="text" class="parameter">
                </div>
                <div id="faceDiv04"></div>
            </div>
            <div class="imagesdiv">
                <div>
                    <text>Images05 Files:</text>
                    <input name="images05" type="file" multiple onchange="loadFaceImage('05', this);" accept="image/png, image/jpeg">
                </div>
                <div>
                    <text>Parameters:</text>
                    <text class="paratitle">groupid</text><input name="group05" type="number" value="5" class="parameter">
                    <text class="paratitle">zoom</text><input name="zoom05" step="0.01" type="number" value="1.0" class="parameter">
                    <text class="paratitle">move-x</text><input name="movex05" type="number" value="0" class="parameter">
                    <text class="paratitle">move-y</text><input name="movey05" type="number" value="0" class="parameter">
                    <text class="paratitle">rotate</text><input name="rotate05" type="number" value="0" class="parameter">
                    <text class="paratitle">trait name</text><input name="trait05" type="text" class="parameter">
                </div>
                <div id="faceDiv05"></div>
            </div>
            <div class="buttons">
                <input id="submit" type="submit" value="Submit & Generate">
                <img id="loading" src="images/loading.gif"  style="width: 20px; height: 20px;margin-top: 0px;display: none;">
            </div>
        </form>
        <div id="showing">
            <button id="showresult" onclick="showresult()">show result</button>
            <a href="nft.zip" download="nft.zip" style="margin-left: 20px;">Download ZIP</a>    
        </div>
        <div id="result" style="display: none;">
        </div>

    <div>
           
    </body>
</html>